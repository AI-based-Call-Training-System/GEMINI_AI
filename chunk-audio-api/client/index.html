<!DOCTYPE html>
<html>
<body>
<button id="startBtn">ğŸ¤ Start Chat</button>
<audio id="replyAudio" controls></audio>

<script>
let ws;
let mediaRecorder;
let audioUrl;

document.getElementById("startBtn").onclick = async () => {
    if (mediaRecorder && mediaRecorder.state === "recording") {
        // ë…¹ìŒ ì¤‘ì§€
        mediaRecorder.stop();
        document.getElementById("startBtn").textContent = "ğŸ¤ Start Chat";
    } else {
        // ì›¹ì†Œì¼“ ì—°ê²° ìƒì„±
        ws = new WebSocket("ws://localhost:8000");
        ws.binaryType = "arraybuffer";

        // ì„œë²„ì—ì„œ ë³´ë‚´ëŠ” ìŒì„± ë°ì´í„° ì²˜ë¦¬
        ws.onmessage = e => {
            if (audioUrl) {
                URL.revokeObjectURL(audioUrl);  // ì´ì „ URL í•´ì œ
            }
            const audioBlob = new Blob([e.data], { type: "audio/wav" });
            audioUrl = URL.createObjectURL(audioBlob);
            document.getElementById("replyAudio").src = audioUrl;
            document.getElementById("replyAudio").play();
        };

        // ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ ë° ìŠ¤íŠ¸ë¦¼ ë°›ê¸°
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        // MediaRecorder ìƒì„±, webm í¬ë§· ì‚¬ìš©
        mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });

        // ë°ì´í„°ê°€ ì¤€ë¹„ë  ë•Œë§ˆë‹¤ ì„œë²„ë¡œ ì „ì†¡
        mediaRecorder.ondataavailable = e => {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(e.data);
            }
        };

        // ë…¹ìŒ ì¤‘ì§€ ì‹œ 'END' ë©”ì‹œì§€ë¡œ ì„œë²„ì— ì „ì†¡
        mediaRecorder.onstop = () => {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send("END");
            }
        };

        mediaRecorder.start(250);
        document.getElementById("startBtn").textContent = "â¹ Stop Chat";
    }
};
</script>
</body>
</html>
